workflows:
  # ============================================
  # ğŸ WORKFLOW iOS - Build Automatizado
  # ============================================
  ios-workflow:
    name: ğŸ iOS Build & Deploy
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    # Trigger automÃ¡tico en push a main
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
      tag_patterns:
        - pattern: 'v*'
          include: true
    
    environment:
      groups:
        # Grupo de credenciales de Apple Developer
        # Configurar en: Codemagic > Applications > Settings > Environment variables
        - app_store_credentials
      
      vars:
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        BUNDLE_ID: "sutodero.app"
        # Configurar APP_STORE_APP_ID en variables de entorno de Codemagic
        # APP_STORE_APP_ID: 1234567890
      
      flutter: 3.24.0  # VersiÃ³n especÃ­fica para consistencia
      xcode: 15.0  # Xcode 15 para iOS 17 support
      cocoapods: default
    
    scripts:
      - name: ğŸ” Verificar entorno
        script: |
          echo "Flutter version:"
          flutter --version
          echo "Xcode version:"
          xcodebuild -version
          echo "CocoaPods version:"
          pod --version
      
      - name: ğŸ“¦ Instalar dependencias Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: ğŸ” Configurar firma de cÃ³digo (Code Signing)
        script: |
          # Codemagic maneja automÃ¡ticamente los certificados
          # si estÃ¡n configurados en el grupo app_store_credentials
          xcode-project use-profiles
      
      - name: ğŸ Instalar CocoaPods
        script: |
          cd ios
          pod repo update
          pod install
          cd ..
      
      - name: ğŸ” AnÃ¡lisis estÃ¡tico de cÃ³digo
        script: |
          flutter analyze || true  # No fallar el build por warnings
      
      - name: ğŸ—ï¸ Build IPA para distribuciÃ³n
        script: |
          flutter build ipa --release \
            --build-name=1.0.0 \
            --build-number=$BUILD_NUMBER \
            --export-options-plist=ios/ExportOptions.plist
      
      - name: ğŸ“‹ InformaciÃ³n del build
        script: |
          echo "âœ… Build completado exitosamente!"
          echo "ğŸ“¦ IPA generado en: build/ios/ipa/"
          ls -lh build/ios/ipa/*.ipa
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      email:
        recipients:
          - mauricioc21@gmail.com
          - info@c21sutodero.com
        notify:
          success: true
          failure: true
      
      # TestFlight - DistribuciÃ³n automÃ¡tica para beta testers
      app_store_connect:
        # Configurar estas variables en Codemagic Environment variables:
        # APP_STORE_CONNECT_KEY_IDENTIFIER
        # APP_STORE_CONNECT_ISSUER_ID
        # APP_STORE_CONNECT_PRIVATE_KEY (contenido del .p8 file)
        
        api_key: $APP_STORE_CONNECT_KEY_IDENTIFIER
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        
        submit_to_testflight: true
        beta_groups:
          - Beta Testers
          - Internal Testing
        
        # EnvÃ­o a App Store (desactivado por defecto)
        submit_to_app_store: false

  # ============================================
  # ğŸ¤– WORKFLOW ANDROID - Build Automatizado
  # ============================================
  android-workflow:
    name: ğŸ¤– Android Build & Deploy
    max_build_duration: 60
    instance_type: linux_x2
    
    # Trigger automÃ¡tico en push a main
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
      tag_patterns:
        - pattern: 'v*'
          include: true
    
    environment:
      groups:
        # Grupo para Google Play credentials (opcional)
        # - google_play_credentials
      
      vars:
        PACKAGE_NAME: "sutodero.app"
      
      flutter: 3.24.0
      java: 17
    
    scripts:
      - name: ğŸ” Verificar entorno
        script: |
          echo "Flutter version:"
          flutter --version
          echo "Java version:"
          java -version
      
      - name: ğŸ“¦ Instalar dependencias Flutter
        script: |
          flutter clean
          flutter pub get
      
      - name: ğŸ” AnÃ¡lisis estÃ¡tico de cÃ³digo
        script: |
          flutter analyze || true  # No fallar el build por warnings
      
      - name: ğŸ—ï¸ Build APK Release
        script: |
          flutter build apk --release \
            --build-name=1.0.0 \
            --build-number=$BUILD_NUMBER \
            --target-platform android-arm,android-arm64,android-x64 \
            --split-per-abi
      
      - name: ğŸ—ï¸ Build App Bundle (AAB) para Play Store
        script: |
          flutter build appbundle --release \
            --build-name=1.0.0 \
            --build-number=$BUILD_NUMBER
      
      - name: ğŸ“‹ InformaciÃ³n del build
        script: |
          echo "âœ… Build completado exitosamente!"
          echo "ğŸ“¦ APKs generados:"
          ls -lh build/app/outputs/flutter-apk/*.apk
          echo "ğŸ“¦ App Bundle:"
          ls -lh build/app/outputs/bundle/release/*.aab
    
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - build/app/outputs/bundle/release/*.aab
      - build/app/outputs/mapping/release/mapping.txt
    
    publishing:
      email:
        recipients:
          - mauricioc21@gmail.com
          - info@c21sutodero.com
        notify:
          success: true
          failure: true
      
      # Google Play - DistribuciÃ³n automÃ¡tica (descomentado cuando estÃ© listo)
      # google_play:
      #   credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
      #   track: internal  # internal, alpha, beta, production
      #   in_app_update_priority: 5

  # ============================================
  # ğŸŒ WORKFLOW WEB - Build Automatizado
  # ============================================
  web-workflow:
    name: ğŸŒ Web Build & Deploy
    max_build_duration: 30
    instance_type: linux_x2
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
    
    environment:
      flutter: 3.24.0
    
    scripts:
      - name: ğŸ“¦ Instalar dependencias
        script: |
          flutter clean
          flutter pub get
      
      - name: ğŸ—ï¸ Build Web
        script: |
          flutter build web --release \
            --web-renderer canvaskit \
            --base-href /sutodero/
      
      - name: ğŸ“‹ InformaciÃ³n del build
        script: |
          echo "âœ… Web build completado!"
          echo "ğŸ“¦ Archivos generados en: build/web/"
          du -sh build/web/
    
    artifacts:
      - build/web/**
    
    publishing:
      email:
        recipients:
          - mauricioc21@gmail.com
        notify:
          success: true
          failure: true
